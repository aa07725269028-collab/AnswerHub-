// النظام الجفري المتكامل - ملف الثوابت
// إصدار متقدم بأقصى دقة حسابية

// ============================================
// 1. الجداول الثابتة الأساسية
// ============================================

// الأبجدية الكبيرة (حساب الجمل الكبير)
const ABJAD_KABIR = {
    'أ': 1, 'ا': 1, 'إ': 1, 'آ': 1,
    'ب': 2,
    'ج': 3,
    'د': 4,
    'ه': 5, 'ة': 5,
    'و': 6,
    'ز': 7,
    'ح': 8,
    'ط': 9,
    'ي': 10,
    'ك': 20,
    'ل': 30,
    'م': 40,
    'ن': 50,
    'س': 60,
    'ع': 70,
    'ف': 80,
    'ص': 90,
    'ق': 100,
    'ر': 200,
    'ش': 300,
    'ت': 400,
    'ث': 500,
    'خ': 600,
    'ذ': 700,
    'ض': 800,
    'ظ': 900,
    'غ': 1000
};

// الأبجدية الوضعية (الجمل الصغير - 28 حرفاً)
const ABJAD_WADII = {
    'أ': 1, 'ا': 1, 'إ': 1, 'آ': 1,
    'ب': 2,
    'ج': 3,
    'د': 4,
    'ه': 5, 'ة': 5,
    'و': 6,
    'ز': 7,
    'ح': 8,
    'ط': 9,
    'ي': 10,
    'ك': 11,
    'ل': 12,
    'م': 13,
    'ن': 14,
    'س': 15,
    'ع': 16,
    'ف': 17,
    'ص': 18,
    'ق': 19,
    'ر': 20,
    'ش': 21,
    'ت': 22,
    'ث': 23,
    'خ': 24,
    'ذ': 25,
    'ض': 26,
    'ظ': 27,
    'غ': 28
};

// جدول النظائر (المتقابلات)
const NAZAIR = {
    'أ': 'س', 'ب': 'ع', 'ج': 'ف', 'د': 'ص', 'ه': 'ق',
    'و': 'ر', 'ز': 'ش', 'ح': 'ت', 'ط': 'ث', 'ي': 'خ',
    'ك': 'ذ', 'ل': 'ض', 'م': 'ظ', 'ن': 'غ', 'س': 'أ',
    'ع': 'ب', 'ف': 'ج', 'ص': 'د', 'ق': 'ه', 'ر': 'و',
    'ش': 'ز', 'ت': 'ح', 'ث': 'ط', 'خ': 'ي', 'ذ': 'ك',
    'ض': 'ل', 'ظ': 'م', 'غ': 'ن'
};

// جدول حاصل النسب الجفري (9x9)
const NISBAT_TABLE = {
    // الصف الأول (الآحاد)
    '1-1': 1, '1-2': 2, '1-3': 3, '1-4': 4, '1-5': 5, '1-6': 6, '1-7': 7, '1-8': 8, '1-9': 9,
    // الصف الثاني
    '2-1': 2, '2-2': 4, '2-3': 6, '2-4': 8, '2-5': 10, '2-6': 12, '2-7': 14, '2-8': 16, '2-9': 18,
    // الصف الثالث
    '3-1': 3, '3-2': 6, '3-3': 3, '3-4': 12, '3-5': 15, '3-6': 3, '3-7': 21, '3-8': 24, '3-9': 3,
    // الصف الرابع
    '4-1': 4, '4-2': 2, '4-3': 12, '4-4': 4, '4-5': 20, '4-6': 6, '4-7': 28, '4-8': 4, '4-9': 36,
    // الصف الخامس
    '5-1': 5, '5-2': 10, '5-3': 15, '5-4': 20, '5-5': 5, '5-6': 30, '5-7': 35, '5-8': 40, '5-9': 45,
    // الصف السادس
    '6-1': 6, '6-2': 3, '6-3': 3, '6-4': 6, '6-5': 30, '6-6': 6, '6-7': 42, '6-8': 12, '6-9': 6,
    // الصف السابع
    '7-1': 7, '7-2': 14, '7-3': 21, '7-4': 28, '7-5': 35, '7-6': 42, '7-7': 7, '7-8': 56, '7-9': 63,
    // الصف الثامن
    '8-1': 8, '8-2': 4, '8-3': 24, '8-4': 4, '8-5': 40, '8-6': 12, '8-7': 56, '8-8': 8, '8-9': 72,
    // الصف التاسع
    '9-1': 9, '9-2': 18, '9-3': 3, '9-4': 36, '9-5': 35, '9-6': 6, '9-7': 63, '9-8': 72, '9-9': 9
};

// ============================================
// 2. دوائر الأسرار المعقدة
// ============================================

// دائرة القوى (دوران الحروف - 6 قواعد)
const DAWRA_ALQUWA = {
    // الطرح العنصري (4-4)
    '4-4': {
        'أ': ['س', 'ع', 'ف', 'ص'],
        'ب': ['ع', 'ف', 'ص', 'ق'],
        'ج': ['ف', 'ص', 'ق', 'ر'],
        'د': ['ص', 'ق', 'ر', 'ش'],
        'ه': ['ق', 'ر', 'ش', 'ت'],
        'و': ['ر', 'ش', 'ت', 'ث'],
        'ز': ['ش', 'ت', 'ث', 'خ'],
        'ح': ['ت', 'ث', 'خ', 'ذ'],
        'ط': ['ث', 'خ', 'ذ', 'ض'],
        'ي': ['خ', 'ذ', 'ض', 'ظ'],
        'ك': ['ذ', 'ض', 'ظ', 'غ'],
        'ل': ['ض', 'ظ', 'غ', 'أ'],
        'م': ['ظ', 'غ', 'أ', 'ب'],
        'ن': ['غ', 'أ', 'ب', 'ج']
    },
    
    // الطرح الكوكبي (7-7)
    '7-7': {
        'أ': ['ز', 'ح', 'ط', 'ي', 'ك', 'ل', 'م'],
        'ب': ['ح', 'ط', 'ي', 'ك', 'ل', 'م', 'ن'],
        'ج': ['ط', 'ي', 'ك', 'ل', 'م', 'ن', 'س'],
        'د': ['ي', 'ك', 'ل', 'م', 'ن', 'س', 'ع'],
        'ه': ['ك', 'ل', 'م', 'ن', 'س', 'ع', 'ف'],
        'و': ['ل', 'م', 'ن', 'س', 'ع', 'ف', 'ص'],
        'ز': ['م', 'ن', 'س', 'ع', 'ف', 'ص', 'ق']
    },
    
    // الطرح الأفلاكي (9-9)
    '9-9': {
        'أ': ['ط', 'ي', 'ك', 'ل', 'م', 'ن', 'س', 'ع', 'ف'],
        'ب': ['ي', 'ك', 'ل', 'م', 'ن', 'س', 'ع', 'ف', 'ص'],
        'ج': ['ك', 'ل', 'م', 'ن', 'س', 'ع', 'ف', 'ص', 'ق'],
        'د': ['ل', 'م', 'ن', 'س', 'ع', 'ف', 'ص', 'ق', 'ر'],
        'ه': ['م', 'ن', 'س', 'ع', 'ف', 'ص', 'ق', 'ر', 'ش']
    }
};

// جدول الطبائع الأربعة
const TABAII = {
    'ناري': ['أ', 'ه', 'ط', 'م', 'ف', 'ش', 'ذ', 'ح'],
    'هوائي': ['ب', 'و', 'ي', 'ن', 'ص', 'ت', 'ض', 'ث'],
    'مائي': ['ج', 'ز', 'ك', 'س', 'ق', 'ث', 'ظ', 'خ'],
    'ترابي': ['د', 'ح', 'ل', 'ع', 'ر', 'خ', 'غ', 'ض']
};

// جدول كسورات الحروف
const KASRAT = {
    'نصف': {
        'أ': 'ب', 'ب': 'ج', 'ج': 'د', 'د': 'ه',
        'ه': 'و', 'و': 'ز', 'ز': 'ح', 'ح': 'ط',
        'ط': 'ي', 'ي': 'ك', 'ك': 'ل', 'ل': 'م',
        'م': 'ن', 'ن': 'س', 'س': 'ع', 'ع': 'ف'
    },
    'ربع': {
        'أ': 'ج', 'ب': 'د', 'ج': 'ه', 'د': 'و',
        'ه': 'ز', 'و': 'ح', 'ز': 'ط', 'ح': 'ي',
        'ط': 'ك', 'ي': 'ل', 'ك': 'م', 'ل': 'ن',
        'م': 'س', 'ن': 'ع', 'س': 'ف', 'ع': 'ص'
    },
    'ثمن': {
        'أ': 'د', 'ب': 'ه', 'ج': 'و', 'د': 'ز',
        'ه': 'ح', 'و': 'ط', 'ز': 'ي', 'ح': 'ك',
        'ط': 'ل', 'ي': 'م', 'ك': 'ن', 'ل': 'س',
        'م': 'ع', 'ن': 'ف', 'س': 'ص', 'ع': 'ق'
    }
};

// ============================================
// 3. دوائر الأسرار الخاصة
// ============================================

// دائرة أيقغ (دوران الحروف الأساسي)
const DAWRA_AYQAGH = {
    'أ': ['ي', 'ق', 'غ', 'س'],
    'ب': ['ك', 'ر', 'أ', 'ع'],
    'ج': ['ل', 'ش', 'ب', 'ف'],
    'د': ['م', 'ت', 'ج', 'ص'],
    'ه': ['ن', 'ث', 'د', 'ق'],
    'و': ['س', 'خ', 'ه', 'ر'],
    'ز': ['ع', 'ذ', 'و', 'ش'],
    'ح': ['ف', 'ض', 'ز', 'ت'],
    'ط': ['ص', 'ظ', 'ح', 'ث'],
    'ي': ['ق', 'غ', 'ط', 'خ'],
    'ك': ['ر', 'أ', 'ي', 'ذ'],
    'ل': ['ش', 'ب', 'ك', 'ض'],
    'م': ['ت', 'ج', 'ل', 'ظ'],
    'ن': ['ث', 'د', 'م', 'غ']
};

// دائرة أنسغ
const DAWRA_ANSAGH = [
    ['أ', 'ب', 'ج', 'د', 'ه', 'و', 'ز'],
    ['ن', 'م', 'ل', 'ك', 'ي', 'ط', 'ح'],
    ['س', 'ع', 'ف', 'ص', 'ق', 'ر', 'ش'],
    ['غ', 'ظ', 'ض', 'ذ', 'خ', 'ث', 'ت']
];

// دائرة أهطم
const DAWRA_AHTAM = {
    'ناري': ['أ', 'ه', 'ط', 'م', 'ف', 'ش', 'ذ', 'ح'],
    'هوائي': ['ب', 'و', 'ي', 'ن', 'ص', 'ت', 'ض', 'ث'],
    'مائي': ['ج', 'ز', 'ك', 'س', 'ق', 'ث', 'ظ', 'خ'],
    'ترابي': ['د', 'ح', 'ل', 'ع', 'ر', 'خ', 'غ', 'ض']
};

// ============================================
// 4. جداول التحويل والمراجع
// ============================================

// تحويل الأرقام إلى حروف (الاستنطاق)
const NUMBER_TO_LETTERS = {
    1: 'أ', 2: 'ب', 3: 'ج', 4: 'د', 5: 'ه',
    6: 'و', 7: 'ز', 8: 'ح', 9: 'ط', 10: 'ي',
    20: 'ك', 30: 'ل', 40: 'م', 50: 'ن',
    60: 'س', 70: 'ع', 80: 'ف', 90: 'ص',
    100: 'ق', 200: 'ر', 300: 'ش', 400: 'ت',
    500: 'ث', 600: 'خ', 700: 'ذ', 800: 'ض',
    900: 'ظ', 1000: 'غ'
};

// تحويل الحروف إلى أرقام (عكسية)
const LETTER_TO_NUMBER = Object.entries(NUMBER_TO_LETTERS).reduce((acc, [num, letter]) => {
    acc[letter] = parseInt(num);
    return acc;
}, {});

// الأبراج الفلكية وقيمها
const BURUJ = {
    'الحمل': { value: 39, element: 'ناري', ruler: 'المريخ' },
    'الثور': { value: 106, element: 'ترابي', ruler: 'الزهرة' },
    'الجوزاء': { value: 203, element: 'هوائي', ruler: 'عطارد' },
    'السرطان': { value: 310, element: 'مائي', ruler: 'القمر' },
    'الأسد': { value: 437, element: 'ناري', ruler: 'الشمس' },
    'السنبلة': { value: 584, element: 'ترابي', ruler: 'عطارد' },
    'الميزان': { value: 751, element: 'هوائي', ruler: 'الزهرة' },
    'العقرب': { value: 938, element: 'مائي', ruler: 'المريخ' },
    'القوس': { value: 1145, element: 'ناري', ruler: 'المشتري' },
    'الجدي': { value: 1372, element: 'ترابي', ruler: 'زحل' },
    'الدلو': { value: 1619, element: 'هوائي', ruler: 'زحل' },
    'الحوت': { value: 1886, element: 'مائي', ruler: 'المشتري' }
};

// منازل القمر
const MANAZIL_ALQAMAR = {
    'الشرطان': { value: 5, letter: 'ب' },
    'البطين': { value: 13, letter: 'ج' },
    'الثريا': { value: 21, letter: 'د' },
    'الدبران': { value: 49, letter: 'ه' },
    'الهقعة': { value: 92, letter: 'و' },
    'الهنعة': { value: 121, letter: 'ز' },
    'الذراع': { value: 145, letter: 'ح' },
    'النثرة': { value: 177, letter: 'ط' },
    'الطرف': { value: 213, letter: 'ي' },
    'الجبهة': { value: 249, letter: 'ك' },
    'الزبرة': { value: 278, letter: 'ل' },
    'الصرفة': { value: 307, letter: 'م' },
    'العواء': { value: 329, letter: 'ن' },
    'السماك': { value: 359, letter: 'س' },
    'الغفر': { value: 394, letter: 'ع' },
    'الزبانا': { value: 427, letter: 'ف' },
    'الإكليل': { value: 460, letter: 'ص' },
    'القلب': { value: 491, letter: 'ق' },
    'الشولة': { value: 519, letter: 'ر' },
    'النعائم': { value: 543, letter: 'ش' },
    'البلدة': { value: 564, letter: 'ت' },
    'سعد الذابح': { value: 589, letter: 'ث' },
    'سعد بلع': { value: 609, letter: 'خ' },
    'سعد السعود': { value: 631, letter: 'ذ' },
    'سعد الأخبية': { value: 657, letter: 'ض' },
    'الفرغ المقدم': { value: 683, letter: 'ظ' },
    'الفرغ المؤخر': { value: 709, letter: 'غ' },
    'الرشا': { value: 737, letter: 'أ' }
};

// ============================================
// 5. دوال المساعدة العامة
// ============================================

// تحقق من صحة الحرف العربي
function isValidArabicChar(char) {
    const arabicRegex = /[\u0600-\u06FF]/;
    return arabicRegex.test(char);
}

// تنظيف النص من الشوائب
function cleanText(text) {
    return text
        .replace(/[^\u0600-\u06FF\s]/g, '') // إزالة غير العربية
        .replace(/\s+/g, ' ') // توحيد المسافات
        .trim();
}

// تقسيم النص إلى حروف
function textToLetters(text) {
    return cleanText(text)
        .replace(/\s/g, '')
        .split('');
}

// الحصول على قيمة الحرف من الأبجد الكبير
function getCharValueKabir(char) {
    return ABJAD_KABIR[char] || 0;
}

// الحصول على قيمة الحرف من الأبجد الوضعي
function getCharValueWadii(char) {
    return ABJAD_WADII[char] || 0;
}

// الرد إلى الآحاد
function reduceToOnes(number) {
    if (number <= 0) return 0;
    if (number <= 9) return number;
    
    let sum = 0;
    while (number > 0) {
        sum += number % 10;
        number = Math.floor(number / 10);
    }
    
    return reduceToOnes(sum);
}

// تطبيق الطرح 9-9 الأفلاكي
function subtractNineNine(number) {
    while (number > 9) {
        number -= 9;
        if (number <= 0) number += 9;
    }
    return number;
}

// تطبيق الطرح 4-4 العنصري
function subtractFourFour(number) {
    while (number > 4) {
        number -= 4;
        if (number <= 0) number += 4;
    }
    return number;
}

// تطبيق الطرح 7-7 الكوكبي
function subtractSevenSeven(number) {
    while (number > 7) {
        number -= 7;
        if (number <= 0) number += 7;
    }
    return number;
}

// تطبيق الطرح 12-12 البروجي
function subtractTwelveTwelve(number) {
    while (number > 12) {
        number -= 12;
        if (number <= 0) number += 12;
    }
    return number;
}

// تطبيق الطرح 28-28 المنازلي
function subtractTwentyEight(number) {
    while (number > 28) {
        number -= 28;
        if (number <= 0) number += 28;
    }
    return number;
}

// تطبيق الطرح 30-30 الدرجي
function subtractThirty(number) {
    while (number > 30) {
        number -= 30;
        if (number <= 0) number += 30;
    }
    return number;
}

// الحصول على طبعة الحرف
function getCharTabia(char) {
    for (const [tabia, chars] of Object.entries(TABAII)) {
        if (chars.includes(char)) {
            return tabia;
        }
    }
    return 'غير معروف';
}

// الحصول على النظير
function getNazir(char) {
    return NAZAIR[char] || char;
}

// الحصول على حاصل النسبة
function getNisbat(a, b) {
    const key = `${a}-${b}`;
    return NISBAT_TABLE[key] || 0;
}

// تحويل الرقم إلى حروف (استنطاق)
function numberToLettersString(number) {
    let result = '';
    let remaining = number;
    
    // ترتيب القيم تنازلياً
    const values = Object.keys(NUMBER_TO_LETTERS)
        .map(Number)
        .sort((a, b) => b - a);
    
    for (const value of values) {
        while (remaining >= value) {
            result += NUMBER_TO_LETTERS[value];
            remaining -= value;
        }
    }
    
    return result;
}

// توليد معرف فريد
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// تصدير الكائنات للاستخدام الخارجي
window.JafrConstants = {
    ABJAD_KABIR,
    ABJAD_WADII,
    NAZAIR,
    NISBAT_TABLE,
    DAWRA_ALQUWA,
    TABAII,
    KASRAT,
    DAWRA_AYQAGH,
    DAWRA_ANSAGH,
    DAWRA_AHTAM,
    NUMBER_TO_LETTERS,
    LETTER_TO_NUMBER,
    BURUJ,
    MANAZIL_ALQAMAR,
    
    // الدوال المساعدة
    isValidArabicChar,
    cleanText,
    textToLetters,
    getCharValueKabir,
    getCharValueWadii,
    reduceToOnes,
    subtractNineNine,
    subtractFourFour,
    subtractSevenSeven,
    subtractTwelveTwelve,
    subtractTwentyEight,
    subtractThirty,
    getCharTabia,
    getNazir,
    getNisbat,
    numberToLettersString,
    generateId
};

console.log('✅ تم تحميل الثوابت الجفرية بنجاح');
