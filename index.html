// ==============================================================================
// إضافة دالة لملء الحقول الفلكية تلقائياً
// ==============================================================================

// دالة حساب رب الساعة (الكوكب) حسب اليوم والساعة
function calculateHourLord() {
    const now = new Date();
    const dayOfWeek = now.getDay(); // 0=أحد, 6=سبت
    const hour = now.getHours();
    
    // جدول الكواكب حسب الأيام (طريقة تقليدية)
    const dayPlanets = {
        0: 'الشمس',   // الأحد للشمس
        1: 'القمر',   // الاثنين للقمر
        2: 'المريخ',  // الثلاثاء للمريخ
        3: 'عطارد',  // الأربعاء لعطارد
        4: 'المشتري', // الخميس للمشتري
        5: 'الزهرة',  // الجمعة للزهرة
        6: 'زحل'     // السبت لزحل
    };
    
    // حساب الكوكب حسب الساعة (كل ساعة يتحكم بها كوكب)
    const hourPlanets = ['الشمس', 'الزهرة', 'عطارد', 'القمر', 'زحل', 'المشتري', 'المريخ'];
    const hourIndex = hour % 7;
    
    return hourPlanets[hourIndex];
}

// دالة حساب طالع البرج حسب الشهر والساعة
function calculateRisingSign() {
    const now = new Date();
    const month = now.getMonth(); // 0-11
    const hour = now.getHours();
    
    // كل برج يغطي حوالي شهر
    const signs = [
        'الحمل', 'الثور', 'الجوزاء', 'السرطان', 
        'الأسد', 'السنبلة', 'الميزان', 'العقرب', 
        'القوس', 'الجدي', 'الدلو', 'الحوت'
    ];
    
    // حساب تقريبي للطالع حسب الشهر والساعة
    let signIndex = month;
    
    // تعديل حسب الساعة (كل ساعتين برج)
    const hourAdjustment = Math.floor(hour / 2) % 12;
    signIndex = (signIndex + hourAdjustment) % 12;
    
    return signs[signIndex];
}

// دالة حساب برج القمر
function calculateMoonSign() {
    const now = new Date();
    const dayOfMonth = now.getDate();
    
    // تغيير برج القمر كل 2.5 يوم تقريباً
    const signs = [
        'الحمل', 'الثور', 'الجوزاء', 'السرطان', 
        'الأسد', 'السنبلة', 'الميزان', 'العقرب', 
        'القوس', 'الجدي', 'الدلو', 'الحوت'
    ];
    
    const signIndex = Math.floor(dayOfMonth / 2.5) % 12;
    return signs[signIndex];
}

// دالة حساب منزلة القمر
function calculateMoonMansion() {
    const now = new Date();
    const dayOfLunarMonth = (now.getDate() % 28) || 28;
    
    const mansions = Object.keys(MANAZIL_ALQAMAR);
    const mansionIndex = (dayOfLunarMonth - 1) % 28;
    return mansions[mansionIndex];
}

// ==============================================================================
// إضافة دالة لملء الحقول تلقائياً في UIHandler
// ==============================================================================

class UIHandler {
    constructor() {
        this.jafrCore = new JafrCore();
        this.isCalculating = false;
        this.initialize();
    }

    initialize() {
        this.populateDropdowns();
        this.setCurrentHijriDate();
        this.autoFillAstronomicalFields(); // إضافة هذه الدالة
        this.setupEventListeners();
        this.updateSystemStatus();
        this.showTableTab('abjad');
    }

    autoFillAstronomicalFields() {
        // ملء رب الساعة (الكوكب)
        const hourLord = calculateHourLord();
        document.getElementById('hourLord').value = hourLord;
        
        // ملء طالع البرج
        const risingSign = calculateRisingSign();
        document.getElementById('risingSign').value = risingSign;
        
        // ملء برج القمر
        const moonSign = calculateMoonSign();
        document.getElementById('moonSign').value = moonSign;
        
        // ملء منزلة القمر
        const moonMansion = calculateMoonMansion();
        document.getElementById('moonMansion').value = moonMansion;
        
        console.log('تم ملء الحقول الفلكية تلقائياً:', {
            hourLord,
            risingSign,
            moonSign,
            moonMansion
        });
    }

    // باقي الدوال كما هي...
}

// ==============================================================================
// إصلاح دالة calculateJawab لضمان ظهور الجواب
// ==============================================================================

class JafrCore {
    // ... باقي الكود ...
    
    calculateJawab() {
        const nazir = this.steps.nazirMustahsala;
        const length = nazir.length;
        if (length === 0) {
            this.steps.jawab = '';
            return;
        }
        
        // طريقة تكسير مؤخر صدر الصحيحة
        // نأخذ الحرف الأخير ثم الأول ثم قبل الأخير ثم الثاني وهكذا
        let jawabArray = [];
        let left = 0;
        let right = length - 1;
        
        while (left <= right) {
            if (left === right) {
                jawabArray.push(nazir[right]);
                break;
            }
            jawabArray.push(nazir[right]); // مؤخر
            jawabArray.push(nazir[left]);  // صدر
            left++;
            right--;
        }
        
        this.steps.jawab = jawabArray.join(' ');
        console.log('الجواب النهائي:', this.steps.jawab);
        this.analyzeJawab(this.steps.jawab);
    }
    
    analyzeJawab(jawab) {
        // تحليل الجواب النهائي
        const letters = jawab.replace(/\s/g, '').split('');
        
        // مقارنة مع الجواب المتوقع إذا وجد
        let matchPercent = 0;
        if (this.expectedAnswer && letters.length > 0) {
            const expectedLetters = textToLetters(this.expectedAnswer);
            let matched = 0;
            
            for (let i = 0; i < Math.min(letters.length, expectedLetters.length); i++) {
                if (letters[i] === expectedLetters[i]) {
                    matched++;
                }
            }
            
            if (expectedLetters.length > 0) {
                matchPercent = Math.round((matched / expectedLetters.length) * 100);
            }
        }
        
        this.analysis.expectedAnswerMatch = matchPercent;
        
        // التكسير
        const takseerResult = this.performTakseer(letters);
        this.analysis.takseer = takseerResult;
        
        // تفسير الجواب
        this.analysis.finalAnswer = this.interpretJawab(letters, takseerResult);
        
        // تخزين الجواب كسلسلة
        this.analysis.finalAnswerString = jawab;
    }
    
    // ... باقي الكود ...
}

// ==============================================================================
// تعديل دالة displayResults لضمان عرض الجواب
// ==============================================================================

class UIHandler {
    // ... باقي الكود ...
    
    displayResults(result) {
        // عرض الجواب النهائي
        const finalAnswerElement = document.getElementById('finalAnswer');
        
        // محاولة استخراج الجواب من multiple sources
        let finalJawab = '';
        if (result.analysis && result.analysis.finalAnswerString) {
            finalJawab = result.analysis.finalAnswerString;
        } else if (result.jawab) {
            finalJawab = result.jawab;
        } else if (result.steps && result.steps.jawab) {
            finalJawab = result.steps.jawab;
        }
        
        if (finalJawab && finalJawab.trim() !== '') {
            // تنسيق الجواب مع ألوان متبادلة
            const formattedJawab = finalJawab.split(' ').map((char, i) => 
                `<span style="color: ${i % 2 === 0 ? '#0d9488' : '#f59e0b'}; font-size: 1.2em; margin: 0 2px;">${char}</span>`
            ).join(' ');
            
            finalAnswerElement.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="color: #f59e0b; margin-bottom: 10px;">الجواب الجفري النهائي:</div>
                    <div style="font-size: 1.5em; line-height: 2; letter-spacing: 5px;">
                        ${formattedJawab}
                    </div>
                    ${this.expectedAnswer ? `
                        <div style="margin-top: 20px; color: #9ca3af;">
                            نسبة المطابقة مع الجواب المتوقع: 
                            <span style="color: ${result.analysis.expectedAnswerMatch > 70 ? '#10b981' : '#f59e0b'}">
                                ${result.analysis.expectedAnswerMatch}%
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            finalAnswerElement.innerHTML = `
                <div style="text-align: center; color: #9ca3af; padding: 40px;">
                    لم يتم استخراج جواب بعد<br>
                    يرجى التأكد من إدخال السؤال بشكل صحيح
                </div>
            `;
        }
        
        // عرض المداخل الأربعة
        const entrances = result.entrances || {};
        document.getElementById('entrancesResult').innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <div style="background: rgba(13, 148, 136, 0.1); padding: 10px; border-radius: 8px;">
                    <div style="color: #9ca3af; font-size: 0.9em;">المدخل الكبير</div>
                    <div style="color: #0d9488; font-weight: bold;">${entrances.madkhalKabir || '--'}</div>
                </div>
                <div style="background: rgba(13, 148, 136, 0.1); padding: 10px; border-radius: 8px;">
                    <div style="color: #9ca3af; font-size: 0.9em;">المدخل الوسيط الكبير</div>
                    <div style="color: #0d9488; font-weight: bold;">${entrances.madkhalWaseetKabir || '--'}</div>
                </div>
                <div style="background: rgba(13, 148, 136, 0.1); padding: 10px; border-radius: 8px;">
                    <div style="color: #9ca3af; font-size: 0.9em;">مجموع المدخل الوسيط</div>
                    <div style="color: #0d9488; font-weight: bold;">${entrances.majmooMadkhalWaseet || '--'}</div>
                </div>
                <div style="background: rgba(13, 148, 136, 0.1); padding: 10px; border-radius: 8px;">
                    <div style="color: #9ca3af; font-size: 0.9em;">المدخل الصغير</div>
                    <div style="color: #0d9488; font-weight: bold;">${entrances.madkhalSagheer || '--'}</div>
                </div>
            </div>
        `;
        
        // عرض إحصائيات الحساب
        document.getElementById('calculationStats').innerHTML = `
            وقت البدء: ${this.jafrCore.startTime ? this.jafrCore.startTime.toLocaleTimeString('ar-SA') : '--'}
            <br>الوقت المستغرق: <span style="color: #0d9488; font-weight: bold;">${result.duration || '--'}</span>
            <br>عدد الخطوات: <span style="color: #f59e0b; font-weight: bold;">15</span>
            <br>الحالة: <span style="color: ${result.success ? '#10b981' : '#ef4444'}; font-weight: bold;">
                ${result.success ? '✅ مكتمل بنجاح' : '❌ فشل'}
            </span>
        `;
        
        // تحديث حالة النظام
        this.updateSystemStatus();
    }
    
    // ... باقي الكود ...
}

// ==============================================================================
// إضافة استدعاء الاختبار التلقائي عند التحميل
// ==============================================================================

document.addEventListener('DOMContentLoaded', () => {
    window.updateProgressUI = (percent, message) => {
        if (window.uiHandler) {
            window.uiHandler.updateProgressUI(percent, message);
        }
    };
    
    window.uiHandler = new UIHandler();
    
    // اختبار تلقائي بعد 2 ثانية من التحميل
    setTimeout(() => {
        console.log('اختبار النظام الجفري...');
        
        // تعبئة نموذج اختباري
        const testQuestion = "إمام زمان كيست";
        const testExpectedAnswer = "محمد مهدي امام باشد";
        
        document.getElementById('mainQuestion').value = testQuestion;
        document.getElementById('expectedAnswer').value = testExpectedAnswer;
        document.getElementById('askerName').value = "السائل";
        
        // ملاحظة: الحقول الفلكية تم ملؤها تلقائياً
        
        console.log('النموذج معبأ وجاهز للاختبار');
        console.log('يمكنك الضغط على زر "بدء الحساب الجفري" للاختبار');
        
        // عرض رسالة توضيحية
        uiHandler.showMessage('info', `
            ✅ تم تعبئة الحقول الفلكية تلقائياً<br>
            ✅ تم إضافة مثال اختباري<br>
            ✅ النظام جاهز للعمل<br>
            <br>
            اضغط على زر "بدء الحساب الجفري" للبدء
        `);
        
    }, 2000);
});
